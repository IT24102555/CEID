<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIC Wizard - Step 1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- ====== Base Styles (your originals, de-duped where possible) ====== -->
    <style>
        :root{
            --bg-1:#0a0a1a; --bg-2:#1a1a2e; --card:rgba(15,23,42,.9);
            --border:rgba(59,130,246,.1); --muted:#94a3b8; --text:#e0e0e0;
            --accent-1:#2563eb; --accent-2:#1d4ed8;
        }
        body{background:linear-gradient(135deg,var(--bg-1),var(--bg-2));color:var(--text);
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;min-height:100vh;}
        .sidebar{position:fixed;top:0;left:0;height:100vh;width:250px;background:linear-gradient(180deg,#0c0c1f,#1a1a3a);color:#fff;box-shadow:2px 0 20px rgba(0,0,0,.3);border-right:1px solid var(--border);z-index:1000}
        .sidebar-header{padding:1.5rem;text-align:center;border-bottom:1px solid rgba(255,255,255,.1)}
        .logo{font-weight:bold;background:linear-gradient(to right,#60a5fa,#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-decoration:none}
        .logo:hover{background:linear-gradient(to right,#93c5fd,#60a5fa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-decoration:none}
        .sidebar-nav{padding:1rem 0}
        .nav-item{margin:.25rem 0}
        .nav-link{color:rgba(255,255,255,.8);padding:.75rem 1.5rem;text-decoration:none;display:flex;align-items:center;transition:.3s;border-left:3px solid transparent}
        .nav-link:hover{color:#fff;background-color:rgba(59,130,246,.1);border-left-color:#3b82f6}
        .nav-link.active{color:#fff;background-color:rgba(59,130,246,.2);border-left-color:#3b82f6}
        .nav-link i{margin-right:.75rem;width:20px;text-align:center}
        
        /* Dropdown Styles */
        .dropdown-container{position:relative}
        .dropdown-toggle{cursor:pointer}
        .dropdown-toggle .fa-chevron-down{transition:transform .3s;font-size:.8rem}
        .dropdown-toggle[aria-expanded="true"] .fa-chevron-down{transform:rotate(180deg)}
        .dropdown-menu{position:absolute;top:100%;left:0;right:0;background:rgba(15,23,42,.95);border:1px solid rgba(59,130,246,.2);border-radius:8px;box-shadow:0 8px 25px rgba(0,0,0,.4);padding:.5rem 0;margin:.25rem 0;z-index:1000;display:none}
        .dropdown-menu.show{display:block}
        .dropdown-item{color:rgba(255,255,255,.8);padding:.75rem 1.5rem;text-decoration:none;display:flex;align-items:center;transition:.3s;border-left:3px solid transparent}
        .dropdown-item:hover{color:#fff;background-color:rgba(59,130,246,.1);border-left-color:#3b82f6;text-decoration:none}
        .dropdown-item i{margin-right:.75rem;width:20px;text-align:center}
        .sidebar-footer{position:absolute;bottom:0;left:0;right:0;padding:1.5rem;border-top:1px solid rgba(255,255,255,.1)}
        .profile-section{display:flex;align-items:center;margin-bottom:1rem}
        .profile-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#2563eb,#1e40af);display:flex;align-items:center;justify-content:center;margin-right:.75rem;font-weight:bold;box-shadow:0 4px 10px rgba(37,99,235,.3)}
        .profile-name{font-size:.9rem;font-weight:600;margin:0}
        .profile-username{font-size:.8rem;color:rgba(255,255,255,.7);margin:0}
        .btn-logout{background:linear-gradient(135deg,#ef4444,#dc2626);border:none;color:#fff;padding:.5rem 1rem;border-radius:8px;text-decoration:none;display:inline-flex;align-items:center;font-size:.9rem;transition:.3s;box-shadow:0 2px 8px rgba(239,68,68,.3)}
        .btn-logout:hover{background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff;text-decoration:none;transform:translateY(-2px);box-shadow:0 4px 12px rgba(239,68,68,.4)}

        .content{margin-left:250px;padding:24px}
        .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.4);max-width:1000px}
        .title{font-size:24px;color:#e0e7ff;margin-bottom:12px}
        .progress{height:10px;background:#1f2937;border-radius:6px;border:1px solid #334155;overflow:hidden;margin-bottom:16px}
        .bar{height:100%;width:25%;background:linear-gradient(135deg,var(--accent-1),var(--accent-2))}
        .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
        label{color:#cbd5e1;display:block;margin-bottom:8px}
        .row{margin-top:16px;display:flex;gap:12px}
        .btn{background:linear-gradient(135deg,var(--accent-1),var(--accent-2));border:none;color:#fff;padding:12px 18px;border-radius:8px;cursor:pointer;box-shadow:0 4px 10px rgba(37,99,235,.3);text-decoration:none}
        @media(max-width:768px){.grid{grid-template-columns:1fr}.sidebar{transform:translateX(-100%)}.content{margin-left:0}}
    </style>

    <!-- ====== Validation UI (tick inside input) ====== -->
    <style>
        .field { position: relative; }
        .input{
            width:100%;padding:12px 42px 12px 14px;border-radius:8px;border:1px solid #334155;
            background:rgba(30,41,59,.7);color:#e2e8f0;outline:none;transition:border-color .2s, box-shadow .2s;
        }
        .input:focus{ border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.2); }
        .status-icon{
            position:absolute;right:12px;top:50%;transform:translateY(-50%);
            font-size:1rem;color:#22c55e;opacity:0;transition:opacity .15s;pointer-events:none;
        }
        .is-valid{ border-color:#22c55e!important; }
        .is-valid + .status-icon{ opacity:1; } /* input immediately followed by icon */
        .is-invalid{ border-color:#ef4444!important; }
        .help-text{ color:#fca5a5; font-size:.8rem; margin-top:.35rem; display:none; }
        .show-help .help-text{ display:block; }
        /* For selects: wrap same as inputs */
        .select-wrap select.input{ appearance:none; }
    </style>
</head>
<body>
<div class="sidebar">
    <div class="sidebar-header">
        <a href="/dashboard" class="logo">
            <i class="fas fa-chart-line me-2"></i>Ceylon Electric
        </a>
    </div>
    <nav class="sidebar-nav">
        <div class="nav-item">
            <a href="/dashboard" class="nav-link">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </a>
        </div>
        <div class="nav-item dropdown-container">
            <a href="#" class="nav-link dropdown-toggle active" id="requestDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-file-alt"></i>
                Request Applications
                <i class="fas fa-chevron-down ms-auto"></i>
            </a>
            <ul class="dropdown-menu" aria-labelledby="requestDropdown">
                <li><a class="dropdown-item" href="/nic/wizard/step1?type=nic">
                    <i class="fas fa-user-alt me-2"></i>NIC Application
                </a></li>
                <li><a class="dropdown-item" href="/nic/wizard/step1?type=driving">
                    <i class="fas fa-id-card me-2"></i>Driving License
                </a></li>
                <li><a class="dropdown-item" href="/nic/wizard/step1?type=passport">
                    <i class="fas fa-passport me-2"></i>Passport
                </a></li>
            </ul>
        </div>
    </nav>
    <div class="sidebar-footer">
        <a href="/profile" class="profile-section" style="text-decoration:none; color:inherit;">
            <div class="profile-avatar">
                <span th:text="${#strings.substring(fullName, 0, 1)}">U</span>
            </div>
            <div class="profile-info">
                <p class="profile-name" th:text="${fullName}">User Name</p>
                <p class="profile-username" th:text="'@' + ${username}">@username</p>
            </div>
        </a>
        <a href="/logout" class="btn-logout">
            <i class="fas fa-sign-out-alt me-2"></i>Logout
        </a>
    </div>
</div>

<div class="content">
    <div class="card">
        <div class="title">Step 1 of 4 · <span th:text="${displayName}">Application</span> Information</div>
        <div class="progress"><div class="bar"></div></div>

        <form id="nicForm" th:action="@{/nic/wizard/step1}" method="post" novalidate>
            <div class="grid">
                <!-- First Name -->
                <div class="field">
                    <label for="firstName">First Name</label>
                    <input class="input" id="firstName" name="firstName" th:value="${nicWizard.firstName}" required />
                    <i class="fa-solid fa-check status-icon" aria-hidden="true"></i>
                    <div class="help-text">Only letters, 2–50 chars.</div>
                </div>

                <!-- Last Name -->
                <div class="field">
                    <label for="lastName">Last Name</label>
                    <input class="input" id="lastName" name="lastName" th:value="${nicWizard.lastName}" required />
                    <i class="fa-solid fa-check status-icon" aria-hidden="true"></i>
                    <div class="help-text">Only letters, 2–50 chars.</div>
                </div>

                <!-- NIC (optional) -->
                <div class="field">
                    <label for="nic">Existing NIC (optional)</label>
                    <input class="input" id="nic" name="nic" th:value="${nicWizard.nic}" />
                    <i class="fa-solid fa-check status-icon" aria-hidden="true"></i>
                    <div class="help-text">Sri Lanka NIC: 9 digits + V/X (e.g., 123456789V) or 12 digits.</div>
                </div>

                <!-- DOB -->
                <div class="field">
                    <label for="dateOfBirth">Date of Birth</label>
                    <input class="input" id="dateOfBirth" name="dateOfBirth" type="date" th:value="${nicWizard.dateOfBirth}" required />
                    <i class="fa-solid fa-check status-icon" aria-hidden="true"></i>
                    <div class="help-text">Must be a valid past date.</div>
                </div>

                <!-- Gender -->
                <div class="field select-wrap">
                    <label for="gender">Gender</label>
                    <select class="input" id="gender" name="gender" th:value="${nicWizard.gender}" required>
                        <option value="" disabled selected>Select…</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                    <i class="fa-solid fa-check status-icon" aria-hidden="true"></i>
                    <div class="help-text">Please choose an option.</div>
                </div>

                <!-- Nationality -->
                <div class="field">
                    <label for="nationality">Nationality</label>
                    <input class="input" id="nationality" name="nationality" th:value="${nicWizard.nationality}" required />
                    <i class="fa-solid fa-check status-icon" aria-hidden="true"></i>
                    <div class="help-text">Only letters/spaces, 2–50 chars.</div>
                </div>

                <!-- Email -->
                <div class="field">
                    <label for="email">Email</label>
                    <input class="input" id="email" name="email" type="email" th:value="${nicWizard.email}" required />
                    <i class="fa-solid fa-check status-icon" aria-hidden="true"></i>
                    <div class="help-text">Enter a valid email (e.g., name@example.com).</div>
                </div>

                <!-- Phone -->
                <div class="field">
                    <label for="phone">Phone</label>
                    <input class="input" id="phone" name="phone" th:value="${nicWizard.phone}" required />
                    <i class="fa-solid fa-check status-icon" aria-hidden="true"></i>
                    <div class="help-text">SL formats: 0XXXXXXXXX or +94XXXXXXXXX.</div>
                </div>

                <!-- Address -->
                <div class="field" style="grid-column:1/-1">
                    <label for="addressLine1">Address</label>
                    <input class="input" id="addressLine1" name="addressLine1" th:value="${nicWizard.addressLine1}" required />
                    <i class="fa-solid fa-check status-icon" aria-hidden="true"></i>
                    <div class="help-text">At least 5 characters.</div>
                </div>

                <!-- City -->
                <div class="field">
                    <label for="city">City</label>
                    <input class="input" id="city" name="city" th:value="${nicWizard.city}" required />
                    <i class="fa-solid fa-check status-icon" aria-hidden="true"></i>
                    <div class="help-text">Only letters/spaces.</div>
                </div>

                <!-- District -->
                <div class="field">
                    <label for="district">District</label>
                    <input class="input" id="district" name="district" th:value="${nicWizard.district}" required />
                    <i class="fa-solid fa-check status-icon" aria-hidden="true"></i>
                    <div class="help-text">Only letters/spaces.</div>
                </div>

                <!-- Postal Code -->
                <div class="field">
                    <label for="postalCode">Postal Code</label>
                    <input class="input" id="postalCode" name="postalCode" th:value="${nicWizard.postalCode}" required />
                    <i class="fa-solid fa-check status-icon" aria-hidden="true"></i>
                    <div class="help-text">5-digit Sri Lankan postal code.</div>
                </div>
            </div>

            <div class="row">
                <button type="submit" class="btn">Continue</button>
                <a href="/dashboard" class="btn" style="background:rgba(30,41,59,.7);border:1px solid #334155;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<!-- ====== Validation Script ====== -->
<script>
    (function () {
        const form = document.getElementById('nicForm');

        // Simple validators per field
        const validators = {
            firstName: v => /^[A-Za-z][A-Za-z\s'.-]{1,49}$/.test(v.trim()),
            lastName:  v => /^[A-Za-z][A-Za-z\s'.-]{1,49}$/.test(v.trim()),
            nic: v => {
                const s = v.trim();
                if (!s) return true; // optional
                const oldFmt = /^\d{9}[VXvx]$/;      // e.g., 123456789V
                const newFmt = /^\d{12}$/;          // e.g., 200012345678
                return oldFmt.test(s) || newFmt.test(s);
            },
            dateOfBirth: v => {
                if (!v) return false;
                const d = new Date(v);
                const today = new Date();
                if (Number.isNaN(d.getTime())) return false;
                return d < new Date(today.getFullYear(), today.getMonth(), today.getDate()); // strictly past
            },
            gender: v => v === 'Male' || v === 'Female' || v === 'Other',
            nationality: v => /^[A-Za-z][A-Za-z\s'.-]{1,49}$/.test(v.trim()),
            email: v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.trim()),
            phone: v => {
                const s = v.trim();
                return /^0\d{9}$/.test(s) || /^\+94\d{9}$/.test(s);
            },
            addressLine1: v => v.trim().length >= 5,
            city: v => /^[A-Za-z][A-Za-z\s'.-]{1,50}$/.test(v.trim()),
            district: v => /^[A-Za-z][A-Za-z\s'.-]{1,50}$/.test(v.trim()),
            postalCode: v => /^\d{5}$/.test(v.trim())
        };

        // hook all inputs/selects
        const fields = Array.from(form.querySelectorAll('.input'));

        function setState(el, isValid) {
            el.classList.remove('is-valid', 'is-invalid');
            el.parentElement.classList.remove('show-help');
            if (isValid) {
                el.classList.add('is-valid');
            } else {
                if (el.hasAttribute('required') || el.value.trim() !== '') {
                    el.classList.add('is-invalid');
                    el.parentElement.classList.add('show-help');
                }
            }
            // tick icon visibility handled by CSS (.is-valid + .status-icon)
        }

        function validateField(el) {
            const id = el.id;
            const v = (el.value ?? '');
            const fn = validators[id];
            if (!fn) return true; // if no validator, treat as valid
            const ok = fn(v);
            setState(el, ok);
            return ok;
        }

        // live validation
        fields.forEach(el => {
            const ev = el.tagName === 'SELECT' || el.type === 'date' ? 'change' : 'input';
            el.addEventListener(ev, () => validateField(el));
            // initial state (useful if server pre-fills values)
            validateField(el);
        });

        // on submit: validate all and block if any invalid
        form.addEventListener('submit', (e) => {
            let allOk = true;
            fields.forEach(el => {
                const ok = validateField(el);
                if (!ok) allOk = false;
            });
            if (!allOk) {
                e.preventDefault();
                // focus first invalid
                const firstBad = form.querySelector('.is-invalid');
                if (firstBad) firstBad.focus();
            }
        });
    })();
    
    // Sidebar dropdown functionality
    document.addEventListener('DOMContentLoaded', function() {
        const dropdownToggle = document.getElementById('requestDropdown');
        const dropdownMenu = dropdownToggle.nextElementSibling;
        
        dropdownToggle.addEventListener('click', function(e) {
            e.preventDefault();
            const isExpanded = dropdownToggle.getAttribute('aria-expanded') === 'true';
            dropdownToggle.setAttribute('aria-expanded', !isExpanded);
            dropdownMenu.classList.toggle('show');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!dropdownToggle.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownToggle.setAttribute('aria-expanded', 'false');
                dropdownMenu.classList.remove('show');
            }
        });
    });
</script>
</body>
</html>

